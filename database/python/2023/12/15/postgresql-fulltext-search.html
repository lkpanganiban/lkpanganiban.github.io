<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1; minimum-scale=1; user-scalable=no;"> <meta content="Full-text search serves as a crucial tool for swiftly retrieving information from a vast collection of text or an unstructured data dump. The approach often involves sifting through a plethora of words or text entries to locate specific information promptly." name="description"> <meta name="keywords" content="postgresql,django"> <meta name="author" content="lkpanganiban"> <meta name="baseurl" content=""> <title> lkpanganiban|Django with PostgreSQL Full-Text Search </title> <!-- favicon --> <link rel="shortcut icon" href="/static/assets/img/favicon.png"> <!-- Main CSS --> <link href="/static/assets/app-20210315.min.css" rel="stylesheet"> <link href="/static/css/custom.css" rel="stylesheet"> <!-- Main Scripts --> <script src="/static/assets/app-20210315.min.js"></script> <script src="/static/assets/blog-20210315.min.js"></script> <!-- Google AdSense --> <!-- <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-6196184620210315", enable_page_level_ads: true }); </script> --> </head> <body id="page-top" class="landing-page"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6336153797582067" crossorigin="anonymous"></script> <div class="search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right: 0px; opacity: 0.95; background-color: #111111; z-index: 9999; display: none;"> <input type="text" class="form-control search-content" id="search-content" style="position: fixed; top: 60px" placeholder="Search Blog"> <div style="position: fixed; top: 16px; right: 16px; z-index: 9999;"> <img src="/static/assets/img/search/cb-close.png" id="close-btn"/> </div> </div> <div style="position: fixed; right: 16px; bottom: 20px; z-index: 9999;"> <img src="/static/assets/img/search/cb-search.png" id="search-btn" title="Double click Ctrl"/> </div> <div class="navbar-wrapper"> <nav class="navbar navbar-default navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/">lkpanganiban</a> </div> <div id="navbar" class="navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li><a class="page-scroll" href="blog/"></a></li> <li> <a class="page-scroll" href="/blog/">Blog</a></li> <li> <a class="page-scroll" href="/python/">Python</a></li> <li> <a class="page-scroll" href="/machine-learning/">Machine Learning</a></li> <li> <a class="page-scroll" href="/database/">Database</a></li> <li> <a class="page-scroll" href="/devops/">Devops</a></li> </ul> </div> </div> </nav> </div> <div class="container-fluid"> <div id="inSlider" class="carousel slide" data-ride="carousel"> <!-- Indicators --> <ol class="carousel-indicators"> <li data-target="#inSlider" data-slide-to="0" class="active"></li> <li data-target="#inSlider" data-slide-to="1"></li> </ol> <!-- Wrapper for slides --> <div class="carousel-inner"> <div class="item active"> <div class="carousel-caption"></div> <img src="/static/assets/img/landing/header_one.webp" alt="first banner image" style="width:100%;"> </div> <div class="item"> <div class="carousel-caption"></div> <img src="/static/assets/img/landing/header_two.jpg" alt="second banner image" style="width:100%;"> </div> </div> <!-- Left and right controls --> <a class="left carousel-control" href="#inSlider" data-slide="prev"> <span class="glyphicon glyphicon-chevron-left"></span> <span class="sr-only">Previous</span> </a> <a class="right carousel-control" href="#inSlider" data-slide="next"> <span class="glyphicon glyphicon-chevron-right"></span> <span class="sr-only">Next</span> </a> </div> </div> <div class="wrapper wrapper-content animated fadeInRight article"> <div class="row"> <div class="col-lg-10 col-lg-offset-1"> <div class="ibox"> <div class="ibox-content"> <div class="pull-right"> <a class="btn btn-white btn-xs" href="/database">Database</a> <a class="btn btn-white btn-xs" href="/python">Python</a> </div> <div class="text-center article-title"> <span class="text-muted"><i class="fa fa-clock-o"></i> 15 Dec 2023</span> <h1> Django with PostgreSQL Full-Text Search </h1> </div> <h1 id="context--problem">Context + Problem</h1> <p>Full-text search serves as a crucial tool for swiftly retrieving information from a vast collection of text or an unstructured data dump. The approach often involves sifting through a plethora of words or text entries to locate specific information promptly. Some databases, such as Elasticsearch or Opensearch, are explicitly designed or prominently feature full-text search capabilities. These solutions exhibit exceptional performance, allowing users to navigate through extensive datasets containing millions of rows in mere milliseconds. However, a notable drawback associated with these systems is their substantial memory requirements, rendering them less suitable for minimal environments, such as those equipped with only 1 core and 1 GB of RAM, where robustness becomes a concern.</p> <p>Addressing this challenge, PostgreSQL’s full-text search functionality emerges as a valuable alternative. While it may not match the sheer performance levels of its counterparts, like Elasticsearch or Opensearch, PostgreSQL’s full-text search offers the advantage of simplicity and integration with existing PostgreSQL installations. This means users can leverage the full-text search capabilities without the need for a separate database dedicated solely to this purpose. In essence, PostgreSQL’s solution provides a balance between functionality and resource efficiency, making it a practical choice for scenarios where maintaining a single database is preferable to managing an additional one exclusively for full-text search. This adaptability allows users to optimize their database environments based on their specific needs and resource constraints.</p> <h1 id="setup">Setup</h1> <h2 id="cloud--postman">Cloud + Postman</h2> <p>The performance evaluation uses Django, Django Rest Framework and PostgreSQL and was conducted in a cloud environment using a Digital Ocean droplet equipped with a small hardware resources: 1 core processor and 1 GB of RAM. The operating system of choice was Ubuntu 22.04 LTS, with Docker serving as the primary containerization runtime to ensure a consistent and reproducible testing environment.</p> <p>The application stack comprised Django as the web framework along with PostgreSQL as the relational database management system. Here, the Django Object-Relational Mapping (ORM) played a pivotal role, functioning as the chief translator responsible for converting user requests into full-text search queries executed on the PostgreSQL database.</p> <p>For the setup above, I’ve used Postman to simulate users querying or hitting the service. Here is the configuration of Postman to simulate the testing and benchmarking of 100 users simultaneously querying or accessing the service.</p> <p align="center"> <img src="/static/assets/img/blog/20231215/postman-configurations.png" alt="postman" width="700" height="900" /> </p> <h2 id="code">Code</h2> <p>Django provides a very nice wrapper to handle the full-text search queries in PostgreSQL. You can use the following code to do this.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.contrib.postgres.search</span> <span class="kn">import</span> <span class="n">SearchVector</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">action</span>
<span class="kn">from</span> <span class="nn">rest_framework_tracking.mixins</span> <span class="kn">import</span> <span class="n">LoggingMixin</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">MyModel</span><span class="p">,</span> <span class="n">MyModelSerializer</span>

<span class="k">class</span> <span class="nc">MyModelViewset</span><span class="p">(</span><span class="n">LoggingMixin</span><span class="p">,</span> <span class="n">viewsets</span><span class="p">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MyModelSerializer</span>
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">text_search</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"q"</span><span class="p">,</span> <span class="s">"*"</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">search</span><span class="o">=</span><span class="n">SearchVector</span><span class="p">(</span>
                <span class="s">"my_model_field_1"</span><span class="p">,</span>
                <span class="s">"my_model_field_2"</span><span class="p">,</span>
                <span class="p">...</span>
                <span class="c1"># more model fields here
</span>            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">text_search</span> <span class="o">!=</span> <span class="s">"*"</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">search</span><span class="o">=</span><span class="n">text_search</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="nb">filter</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">start_from</span><span class="p">:</span> <span class="n">start_from</span><span class="o">+</span><span class="n">size</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">serializer_class</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">data</span>
        <span class="n">template</span><span class="p">[</span><span class="s">"features"</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">template</span><span class="p">[</span><span class="s">"total"</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
</code></pre></div></div> <p>You can still improve the code above by adding pagination and permission classes. Pagination is a technique that allows you to split your data into smaller chunks and display them on different pages. This can improve the performance and usability of your application, especially when you have a large amount of data. Permission classes are a way to control who can access or modify your data. You can define different levels of permissions based on the user’s role, authentication, or other criteria. This can enhance the security and privacy of your application, as well as prevent unauthorized or malicious actions.</p> <p>We can notice that the code above is easier to implement. Some integration like Elasticsearch will require you to install a DSL library and implement a <code class="language-plaintext highlighter-rouge">documents.py</code> just to properly index the fields. Elasticsearch is a popular and powerful full-text search engine that can handle large-scale and distributed data. However, it also requires more resources and setup to use. You need to install and run Elasticsearch as a separate service, and communicate with it using a REST API or a DSL library. You also need to define and update the schema of your data, and create and manage the documents that represent your data. This can add more complexity and overhead to your application development and maintenance.</p> <h1 id="results">Results</h1> <p align="center"> <img src="/static/assets/img/blog/20231215/postman-performance.png" alt="postman-performance" width="950" height="500" /> </p> <p>PostgreSQL’s full text search is a powerful feature that allows you to perform complex queries on text data. It provides the performance above, which means that it can handle a large number of requests per second with low latency. During the performance test, we measured the CPU and memory usage of our system. The CPU usage was pegged at 100%, which indicates that the CPU is the limiting factor for our system’s performance. The memory usage was about 45%, which means that we still have some free memory available. We can infer that our system is bottlenecked by the CPU, and that we could improve the performance by upgrading the CPU or adding more CPU cores.</p> <p>Overall, this is already a good enough result for small system deployments, such as personal projects or prototypes. You can have a feature rich application that is very functional, without requiring a lot of resources or configuration.</p> <hr> <div class="row"> <div class="col-md-6"> <h5 style="display: inline;">Tags:</h5> <button class="btn btn-white btn-xs" type="button">postgresql</button> <button class="btn btn-white btn-xs" type="button">django</button> </div> <div class="col-md-6"> <div class="small text-right"> <div> </div> </div> </div> </div> <br> <div class="row"> <div class="col-lg-12"> <!-- donate --> <br> <!-- share --> <div class="a2a_kit a2a_kit_size_32 a2a_default_style"> <a class="a2a_dd" href="https://www.addtoany.com/share"></a> <a class="a2a_button_facebook"></a> <a class="a2a_button_twitter"></a> <a class="a2a_button_google_plus"></a> <a class="a2a_button_linkedin"></a> <a class="a2a_button_email"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_sina_weibo"></a> <a class="a2a_button_pocket"></a> </div> <script> var a2a_config = a2a_config || {}; a2a_config.color_main = "D7E5ED"; a2a_config.color_border = "AECADB"; a2a_config.color_link_text = "333333"; a2a_config.color_link_text_hover = "333333"; </script> <script async src="https://static.addtoany.com/menu/page.js"></script> <br> <!-- comment --> </div> </div> </div> </div> </div> </div> </div> <!-- Google analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-PQC0GXQ1JC" ></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag("js", new Date()); gtag("config", "G-PQC0GXQ1JC"); </script> <!-- GrowingIO --> </body> </html>
